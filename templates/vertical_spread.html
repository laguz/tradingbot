{% extends 'layout.html' %}

{% block title %}Vertical Spreads{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h4 class="card-title">Place a Vertical Spread Order</h4>
        <p class="card-text">
            Build a two-leg vertical spread. Enter a ticker to load available expiration dates.
        </p>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mt-3" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('spreads.submit_vertical_spread') }}" class="mt-4">
            {{ form.hidden_tag() }}

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div data-mdb-input-init class="form-outline">
                        {{ form.symbol(class="form-control") }}
                        {{ form.symbol.label(class="form-label") }}
                    </div>
                    {% for error in form.symbol.errors %}
                        <div class="text-danger small ms-1 mt-1">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-md-6 mb-4">
                    {{ form.expiration.label(class="form-label") }}
                    {{ form.expiration(class="form-select") }}
                     {% for error in form.expiration.errors %}
                        <div class="text-danger small ms-1 mt-1">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-4">
                    {{ form.spread_type.label(class="form-label") }}
                    {{ form.spread_type(class="form-select") }}
                </div>
                <div class="col-md-6 mb-4">
                    {{ form.option_type.label(class="form-label") }}
                    {{ form.option_type(class="form-select") }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-4">
                    <div data-mdb-input-init class="form-outline">
                        {{ form.long_strike(class="form-control") }}
                        {{ form.long_strike.label(class="form-label") }}
                    </div>
                     {% for error in form.long_strike.errors %}
                        <div class="text-danger small ms-1 mt-1">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="col-md-4 mb-4">
                     <div data-mdb-input-init class="form-outline">
                        {{ form.short_strike(class="form-control") }}
                        {{ form.short_strike.label(class="form-label") }}
                    </div>
                    {% for error in form.short_strike.errors %}
                        <div class="text-danger small ms-1 mt-1">{{ error }}</div>
                    {% endfor %}
                </div>
                 <div class="col-md-4 mb-4">
                    <div data-mdb-input-init class="form-outline">
                        {{ form.quantity(class="form-control") }}
                        {{ form.quantity.label(class="form-label") }}
                    </div>
                    {% for error in form.quantity.errors %}
                        <div class="text-danger small ms-1 mt-1">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>

            {{ form.submit(class="btn btn-primary btn-block") }}
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const symbolInput = document.getElementById('symbol');
    const expirationSelect = document.getElementById('expiration');

    async function fetchExpirations(symbol) {
        if (!symbol) {
            expirationSelect.innerHTML = '<option value="">Enter a symbol first</option>';
            return;
        }
        
        // Add a loading indicator
        expirationSelect.innerHTML = '<option value="">Loading...</option>';

        try {
            const response = await fetch(`/api/expirations/${symbol.toUpperCase()}`);
            
            // --- UPDATED ERROR HANDLING ---
            if (!response.ok) {
                const errorData = await response.json().catch(() => null); // Try to parse error
                const errorMessage = errorData ? errorData.error : 'Invalid Ticker or API Error';
                expirationSelect.innerHTML = `<option value="">Error: ${errorMessage}</option>`;
                throw new Error(errorMessage);
            }
            // --- END OF UPDATE ---

            const dates = await response.json();
            
            expirationSelect.innerHTML = ''; // Clear existing options

            if (dates && dates.length > 0) {
                dates.forEach(date => {
                    const option = new Option(date, date);
                    expirationSelect.add(option);
                });

                // Set the default to the third expiration date, if available
                if (dates.length >= 3) {
                    expirationSelect.selectedIndex = 2; // 0-indexed, so 2 is the third item
                }
            } else {
                expirationSelect.innerHTML = '<option value="">No expirations found</option>';
            }
        } catch (error) {
            console.error('Error fetching expiration dates:', error);
        }
    }

    // Add event listener to fetch expirations when the user changes the ticker
    symbolInput.addEventListener('change', () => {
        fetchExpirations(symbolInput.value);
    });

    // Fetch expirations for the default ticker on page load
    if (symbolInput.value) {
        fetchExpirations(symbolInput.value);
    }
});
</script>
{% endblock %}