{% extends "layout.html" %}

{% block title %}Automated Trader{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4"><i class="fas fa-robot me-2"></i>Automated Trading Bot</h2>

        <!-- Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h6 class="text-muted">Status</h6>
                        <h4 id="botStatus" aria-live="polite" aria-atomic="true">Loading...</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h6 class="text-muted">Daily P&L</h6>
                        <h4 id="dailyPnl" aria-live="polite" aria-atomic="true">$0.00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h6 class="text-muted">Positions</h6>
                        <h4 id="positions" aria-live="polite" aria-atomic="true">0/0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h6 class="text-muted">Today's Trades</h6>
                        <h4 id="todayTrades" aria-live="polite" aria-atomic="true">0</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="card bg-dark text-light mb-4">
            <div class="card-header bg-primary">
                <h5 class="mb-0">Controls</h5>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 mb-3">
                    <button id="runBtn" class="btn btn-success btn-ripple" onclick="runBot()"
                        aria-label="Run trading bot now">
                        <i class="fas fa-play me-2" aria-hidden="true"></i>Run Now
                    </button>
                    <button id="emergencyBtn" class="btn btn-danger btn-ripple" onclick="emergencyStop()"
                        aria-label="Emergency stop all trading">
                        <i class="fas fa-stop-circle me-2" aria-hidden="true"></i>Emergency Stop
                    </button>
                    <button id="resumeBtn" class="btn btn-warning btn-ripple" onclick="resume()" style="display:none;"
                        aria-label="Resume trading after emergency stop">
                        <i class="fas fa-play-circle me-2" aria-hidden="true"></i>Resume
                    </button>
                </div>

                <div id="configInfo" class="small text-muted"></div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="card bg-dark text-light">
            <div class="card-header bg-primary">
                <h5 class="mb-0">Recent Trades (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Strategy</th>
                                <th>Details</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>P/L</th>
                                <th>Confidence</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTable">
                            <tr>
                                <td colspan="9" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let statusInterval;

    async function loadStatus() {
        try {
            const response = await fetch('/api/autotrader/status');
            const data = await response.json();

            if (data.success) {
                // Update status cards
                const risk = data.risk_status;
                document.getElementById('botStatus').textContent = risk.emergency_stop ? 'üõë STOPPED' :
                    (risk.can_trade ? '‚úì Ready' : '‚ö† Limited');
                document.getElementById('dailyPnl').textContent = `$${risk.daily_pnl.toFixed(2)}`;
                document.getElementById('dailyPnl').className = risk.daily_pnl >= 0 ? 'text-success' : 'text-danger';
                document.getElementById('positions').textContent = `${risk.position_count}/${risk.max_positions}`;
                document.getElementById('todayTrades').textContent = data.stats.total_trades;

                // Update config info
                const mode = data.config.dry_run ? 'üß™ DRY RUN MODE' : 'üí∞ LIVE TRADING';
                const enabled = data.config.enabled ? '‚úì Enabled' : '‚úó Disabled';
                document.getElementById('configInfo').innerHTML = `
        ${mode} | ${enabled} | Symbols: ${data.config.symbols.join(', ')} | 
        Max Loss: $${data.config.max_daily_loss}
      `;

                // Update button states
                document.getElementById('emergencyBtn').style.display = risk.emergency_stop ? 'none' : 'inline-block';
                document.getElementById('resumeBtn').style.display = risk.emergency_stop ? 'inline-block' : 'none';

                // Update trades table
                updateTradesTable(data.recent_trades);
            }
        } catch (error) {
            console.error('Error loading status:', error);
        }
    }

    function updateTradesTable(trades) {
        const tbody = document.getElementById('tradesTable');

        if (trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">No trades yet</td></tr>';
            return;
        }

        tbody.innerHTML = trades.map(trade => {
            const time = new Date(trade.timestamp).toLocaleString();
            const details = trade.details ? `${trade.details.strike || trade.details.short_strike || ''} ${trade.details.option_type || ''}` : '';
            const conf = (trade.ml_confidence * 100).toFixed(0) + '%';
            const status = trade.dry_run ? 'üß™ Dry Run' : (trade.result?.success ? '‚úì Success' : '‚úó Failed');

            // Extract entry price from order details or result
            let entryPrice = '-';
            let entryPriceNum = 0;
            if (trade.details && trade.details.price) {
                entryPriceNum = parseFloat(trade.details.price);
                entryPrice = `$${entryPriceNum.toFixed(2)}`;
            } else if (trade.result && trade.result.order && trade.result.order.avg_fill_price) {
                entryPriceNum = parseFloat(trade.result.order.avg_fill_price);
                entryPrice = `$${entryPriceNum.toFixed(2)}`;
            } else if (trade.result && trade.result.avg_fill_price) {
                entryPriceNum = parseFloat(trade.result.avg_fill_price);
                entryPrice = `$${entryPriceNum.toFixed(2)}`;
            }

            // Extract exit price if position was closed
            let exitPrice = '-';
            let exitPriceNum = 0;
            if (trade.action === 'close' && trade.details && trade.details.price) {
                exitPriceNum = parseFloat(trade.details.price);
                exitPrice = `$${exitPriceNum.toFixed(2)}`;
            } else if (trade.result && trade.result.exit_price) {
                exitPriceNum = parseFloat(trade.result.exit_price);
                exitPrice = `$${exitPriceNum.toFixed(2)}`;
            }

            // Calculate P/L
            let pnl = '-';
            let pnlClass = '';
            const quantity = trade.details?.quantity || 1;

            if (trade.action === 'close' && entryPriceNum > 0 && exitPriceNum > 0) {
                // For closing: sold at entry, bought back at exit
                // P/L = (entry - exit) * quantity * 100 (options are 100 shares per contract)
                const pnlValue = (entryPriceNum - exitPriceNum) * quantity * 100;
                pnl = `$${pnlValue.toFixed(2)}`;
                pnlClass = pnlValue >= 0 ? 'text-success' : 'text-danger';
            } else if (trade.action === 'open' && entryPriceNum > 0) {
                // For opening (sell to open): credit received
                const pnlValue = entryPriceNum * quantity * 100;
                pnl = `$${pnlValue.toFixed(2)}`;
                pnlClass = 'text-success'; // Credit received
            }

            return `
      <tr>
        <td>${time}</td>
        <td>${trade.symbol}</td>
        <td>${trade.strategy}</td>
        <td>${details}</td>
        <td>${entryPrice}</td>
        <td>${exitPrice}</td>
        <td class="${pnlClass}">${pnl}</td>
        <td>${conf}</td>
        <td>${status}</td>
      </tr>
    `;
        }).join('');
    }

    async function runBot() {
        if (!confirm('Run the trading bot now?')) return;

        const btn = document.getElementById('runBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running...';

        try {
            const response = await fetch('/api/autotrader/run', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                toastSuccess('Bot started! Check the logs for progress.');
                setTimeout(loadStatus, 2000);
            } else {
                toastError('Error: ' + data.error);
            }
        } catch (error) {
            toastError('Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play me-2"></i>Run Now';
        }
    }

    async function emergencyStop() {
        if (!confirm('‚ö†Ô∏è EMERGENCY STOP - This will halt all trading. Continue?')) return;

        try {
            const response = await fetch('/api/autotrader/emergency_stop', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                toastWarning('‚ö†Ô∏è Emergency stop activated!', 6000);
                loadStatus();
            } else {
                toastError('Failed to activate emergency stop');
            }
        } catch (error) {
            toastError('Error: ' + error.message);
        }
    }

    async function resume() {
        if (!confirm('Resume trading after emergency stop?')) return;

        try {
            const response = await fetch('/api/autotrader/resume', { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                toastSuccess('Trading resumed!');
                loadStatus();
            } else {
                toastError('Failed to resume trading');
            }
        } catch (error) {
            toastError('Error: ' + error.message);
        }
    }

    // Initial load and auto-refresh
    loadStatus();
    statusInterval = setInterval(loadStatus, 10000);  // Refresh every 10 seconds
</script>
{% endblock %}