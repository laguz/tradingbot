{% extends 'layout.html' %}

{% block title %}ML Performance Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">ML Performance Dashboard</h1>

<!-- Filter Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <form method="GET">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="ticker" class="form-label">Ticker Symbol</label>
                            <input type="text" class="form-control" id="ticker" name="ticker"
                                value="{{ ticker if ticker != 'All' else '' }}" placeholder="Leave empty for all">
                        </div>
                        <div class="col-md-4">
                            <label for="days" class="form-label">Time Period (days)</label>
                            <select class="form-select" id="days" name="days">
                                <option value="7" {% if days==7 %}selected{% endif %}>7 days</option>
                                <option value="30" {% if days==30 %}selected{% endif %}>30 days</option>
                                <option value="60" {% if days==60 %}selected{% endif %}>60 days</option>
                                <option value="90" {% if days==90 %}selected{% endif %}>90 days</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">Filter</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Actions</h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary btn-ripple" onclick="backfillPrices()"
                        aria-label="Backfill actual stock prices">
                        <i class="fas fa-sync-alt" aria-hidden="true"></i> Backfill Prices
                    </button>
                    <button class="btn btn-info btn-ripple" onclick="runValidation()"
                        aria-label="Run ML model validation">
                        <i class="fas fa-chart-line" aria-hidden="true"></i> Run Validation
                    </button>
                </div>
                <small id="action-status" class="text-muted" role="status" aria-live="polite"></small>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
{% if performance and 'error' not in performance %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">MAE (Mean Absolute Error)</h6>
                <h3 class="fw-bold">${{ "%.2f"|format(performance.mae) }}</h3>
                <small class="text-muted">Average price error</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">RMSE</h6>
                <h3 class="fw-bold">${{ "%.2f"|format(performance.rmse) }}</h3>
                <small class="text-muted">Root mean squared error</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">MAPE</h6>
                <h3 class="fw-bold">{{ "%.1f"|format(performance.mape) }}%</h3>
                <small class="text-muted">Mean percentage error</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="text-muted">Directional Accuracy</h6>
                <h3
                    class="fw-bold {% if performance.directional_accuracy >= 55 %}text-success{% else %}text-warning{% endif %}">
                    {{ "%.1f"|format(performance.directional_accuracy) }}%
                </h3>
                <small class="text-muted">Correct up/down calls</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5>Summary</h5>
                <p class="mb-1"><strong>Ticker:</strong> {{ performance.ticker }}</p>
                <p class="mb-1"><strong>Period:</strong> Last {{ performance.period_days }} days</p>
                <p class="mb-1"><strong>Total Predictions:</strong> {{ performance.num_predictions }}</p>
                <p class="mb-0"><strong>Average Confidence:</strong>
                    {{ "%0.2f"|format(performance.avg_confidence) if performance.avg_confidence else 'N/A' }}
                </p>
            </div>
        </div>
    </div>
</div>
{% elif performance and 'error' in performance %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> {{ performance.error }}
</div>
{% endif %}

<!-- Recent Predictions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Recent Predictions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Predicted Date</th>
                                <th>Target Date</th>
                                <th>Predicted Price</th>
                                <th>Actual Price</th>
                                <th>Error</th>
                                <th>Model Version</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pred in predictions %}
                            <tr>
                                <td><strong>{{ pred.symbol }}</strong></td>
                                <td>{{ pred.prediction_date }}</td>
                                <td>{{ pred.target_date }}</td>
                                <td>${{ "%.2f"|format(pred.predicted_price) }}</td>
                                <td>
                                    {% if pred.actual_price %}
                                    ${{ "%.2f"|format(pred.actual_price) }}
                                    {% else %}
                                    <span class="text-muted">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pred.error %}
                                    ${{ "%.2f"|format(pred.error) }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><small class="badge bg-primary">{{ pred.model_version }}</small></td>
                                <td>{{ "%.3f"|format(pred.confidence) if pred.confidence else '-' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center text-muted">No predictions found</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Validation Results Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Walk-Forward Validation Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="validation-results">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    function backfillPrices() {
        document.getElementById('action-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Backfilling...';

        fetch('/api/ml/backfill', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('action-status').innerHTML =
                        '<i class="fas fa-check-circle text-success"></i> ' + data.message;
                    toastSuccess('Backfill completed: ' + data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    document.getElementById('action-status').innerHTML =
                        '<i class="fas fa-times-circle text-danger"></i> Error: ' + data.error;
                    toastError('Backfill failed: ' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('action-status').innerHTML =
                    '<i class="fas fa-times-circle text-danger"></i> Request failed';
                toastError('Request failed: ' + error.message);
            });
    }

    function runValidation() {
        const ticker = '{{ ticker if ticker != "All" else "SPY" }}';

        document.getElementById('action-status').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running validation...';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('validationModal'));
        modal.show();

        fetch(`/api/ml/validate/${ticker}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                train_size: 252,
                test_size: 21,
                n_splits: 5
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Format results HTML
                    let html = `
                <h5>${data.ticker} Validation Summary</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card"><div class="card-body text-center">
                            <h6>Avg MAE</h6>
                            <h4>$${data.summary.avg_mae.toFixed(2)}</h4>
                        </div></div>
                    </div>
                    <div class="col-md-4">
                        <div class="card"><div class="card-body text-center">
                            <h6>Avg RMSE</h6>
                            <h4>$${data.summary.avg_rmse.toFixed(2)}</h4>
                        </div></div>
                    </div>
                    <div class="col-md-4">
                        <div class="card"><div class="card-body text-center">
                            <h6>Avg Dir. Acc</h6>
                            <h4>${data.summary.avg_directional_accuracy}%</h4>
                        </div></div>
                    </div>
                </div>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Split</th>
                            <th>Test Period</th>
                            <th>MAE</th>
                            <th>RMSE</th>
                            <th>Dir. Acc</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

                    data.results.forEach(r => {
                        html += `
                    <tr>
                        <td>${r.split}</td>
                        <td>${r.test_period}</td>
                        <td>$${r.mae}</td>
                        <td>$${r.rmse}</td>
                        <td>${r.directional_accuracy}%</td>
                    </tr>
                `;
                    });

                    html += '</tbody></table>';
                    document.getElementById('validation-results').innerHTML = html;
                    document.getElementById('action-status').innerHTML =
                        '<i class="fas fa-check-circle text-success"></i> Validation complete';
                } else {
                    document.getElementById('validation-results').innerHTML =
                        '<div class="alert alert-danger">Error: ' + data.error + '</div>';
                    document.getElementById('action-status').innerHTML =
                        '<i class="fas fa-times-circle text-danger"></i> Validation failed';
                }
            })
            .catch(error => {
                document.getElementById('validation-results').innerHTML =
                    '<div class="alert alert-danger">Request failed</div>';
                document.getElementById('action-status').innerHTML =
                    '<i class="fas fa-times-circle text-danger"></i> Request failed';
            });
    }
</script>

{% endblock %}